name: CI

on:
  push:
  pull_request:

jobs:
  python:
    name: Python (lint & test)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: py
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install tools
        run: |
          python -m pip install --upgrade pip
          pip install pytest black ruff

      - name: Lint (ruff) & Format check (black)
        run: |
          ruff check src tests
          black --check src tests

      - name: Run tests (pytest)
        env:
          PLAYGROUND_ROOT: ${{ github.workspace }}
        run: pytest -q

      - name: Upload Python results (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: py-results
          path: ${{ github.workspace }}/data/results/**
          if-no-files-found: ignore

  c:
    name: C (build & test)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show workspace (debug)
        run: |
          echo "GITHUB_WORKSPACE = $GITHUB_WORKSPACE"
          pwd
          echo "== ls -la =="
          ls -la
          echo "== git ls-tree HEAD =="
          git ls-tree --name-only HEAD

      - name: Ensure c/ exists
        run: |
          if [ ! -d "$GITHUB_WORKSPACE/c" ]; then
            echo "::error::c/ directory not found at $GITHUB_WORKSPACE"
            exit 1
          fi

      - name: Build (make)
        run: make -C c

      - name: Run C tests
        run: make -C c test

      - name: Upload C results (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: c-results
          path: ${{ github.workspace }}/data/results/**
          if-no-files-found: ignore

  go:
    name: Go (test)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # go/ の存在を判定してフラグ出力
      - name: Check go/ exists
        id: check_go
        run: |
          if [ -d "${GITHUB_WORKSPACE}/go" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Go
        if: steps.check_go.outputs.exists == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.1'    # go.mod に合わせて変更可
          cache: true

      - name: Go test
        if: steps.check_go.outputs.exists == 'true'
        working-directory: go
        run: go test ./... -v

      # （任意）カバレッジを artifact に残す
      - name: Coverage (optional)
        if: steps.check_go.outputs.exists == 'true'
        working-directory: go
        run: go test ./... -coverprofile=cover.out

      - name: Upload Go coverage (optional)
        if: steps.check_go.outputs.exists == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: go-coverage
          path: go/cover.out
          if-no-files-found: ignore
